

## 설명
오밀조밀 프로젝트를 실제로 적용시키기 위해서는 각 위병소마다 카메라를 설치하여 서버로 이미지를 전송해야 합니다.
해당 과정을 별다른 설치프로그램 없이 사용하기 위해서 webrtc와 websocket을 이용해 구현하였습니다.

모든 PC마다 설치되어 있는 웹브라우저를 이용하여 카메라로부터 사진을 찍습니다.
찍은 사진을 websocket을 통해 서버로 전달합니다.
전달받은 사진을 ai를 통해 분석합니다.

참고자료 : https://developer.mozilla.org/ko/docs/Web/API/WebRTC_API

## 핵심기능
1. webrtc를 사용하여 사진 촬영
해당 기능을 통해 pc에 추가 프로그램 설치 없이 카메라와 웹브라우져만 있으면 동작할 수 있다.

2. frontend에서 websocket 으로 이미지 수신
해당 기능을 통해 실시간으로 ai 처리과를 확인 할 수 있다.

3. 이미지 수신 프로세스와 ai 처리 프로세스 분리
갑자기 요청이 몰리거나 ai 처리중 지연이 발생하는 경우 서버내 메모리가 부족하여 서버가 죽어버릴 수 있다.
이미지를 받는 프로세스와 처리하는 프로세스를 분리하여 이미지를 바로 처리하는 것이 아닌 파일로 저장을 하여 메모리 부족 문제를 해결하였습니다.

4. 구간별로 ai 처리결과에 따른 처리
사람이 아닌 경우, 사람인데

## 동작 과정
1. webrtc를 사용하여 해당 기기에 있는 카메라를 감지하여 해당 카메라로부터 촬영을 합니다.
2. 촬영한 이미지를 websocket을 통해 서버로 전달합니다.
3. 받은 이미지를 1차로 분석하여 사람인 경우 파일로 저장하고 해당 경로를 ai 처리 프로세서로 전달합니다.
4. ai 처리 프로세서는 받은 경로를 queue 형식으로 저장하여 이미지를 하나씩 분석합니다.
5. 분석 완료된 이미지를 websocket을 통해 빠르게 클라이언트로 전달을 하고 DB에 저장합니다.

## 이미지 처리 과정
1. 수신한 이미지가 사람인지 아닌지 파악합니다.
1.1. 사람이 아닌 경우 더 이상 진행하지 않습니다.

2. 사람인 경우 해당 이미지를 파일로 저장합니다.
2.1. 저장한 이미지 경로를 socket을 사용하여 ai 프로세서로 전달합니다.

3. 받은 경로를 queue 형식으로 저장하고 이미지를 처리할 worker 프로세스를 생성합니다.
3.1 각 카메라별로 최대 1개의 프로세서가 실행됩니다.
3.2 이미지를 파일로 저장하고 queue형식으로 관리를 하여 처리해야될 이미지가 많은 경우 서버의 메모리가 터져버리는 경우를 막았습니다.

4. worker 프로세스에서 queue에 저장된 경로를 참조하여 이미지를 하나씩 분석합니다.

5. 분석이 완료된 경우 해당 결과에 따라 처리합니다.
5.1. 분석결과를 websocket을 통해 실시간으로 처리결과를 화면에 띄워줍니다.
5.2. 분석결과를 DB에 저장합니다.

6. 연속적인 이미지인 경우 이전 이미지를 참조하여 데이터를 갱신합니다.
6.1. 데이터가 갱신된 경우만 DB를 접근합니다.
6.2. 일정 시간 이상 ai 처리결과가 동일한 경우 해당 사람에 대해 더이상 ai가 처리하지 않습니다.
